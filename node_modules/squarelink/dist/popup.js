'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _promise = require('babel-runtime/core-js/promise');

var _promise2 = _interopRequireDefault(_promise);

var _iframe = require('./iframe');

var _iframe2 = _interopRequireDefault(_iframe);

var _styles = require('./styles');

var _styles2 = _interopRequireDefault(_styles);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var POPUP_PARAMS = 'scrollbars=no,resizable=no,status=no,location=no,toolbar=no,menubar=no,width=375,height=350,left=-500,top=150';

var getPopup = function getPopup(_ref) {
  var url = _ref.url,
      params = _ref.params;

  /* INITIALIZE HEADER STYLES */
  var style = document.createElement('style');
  style.innerHTML = _styles2.default;
  var head = document.head || document.getElementsByTagName('head')[0];
  head.appendChild(style);

  /* INITIALIZE POPUP DIALOG */
  var popup = window.open('', '_blank', POPUP_PARAMS);
  if (!popup || popup.closed || typeof popup.closed == 'undefined') {
    try {
      popup.close();
    } catch (err) {}
    return _promise2.default.resolve({ iframe: new _iframe2.default(url, params) });
  }
  return _loadPopup({ url: url, popup: popup, params: params });
};

var _loadPopup = function _loadPopup(_ref2) {
  var url = _ref2.url,
      popup = _ref2.popup,
      params = _ref2.params;
  return new _promise2.default(function (resolve, reject) {
    popup.location.href = url;
    var result = false;
    window.addEventListener('message', function (e) {
      if (result) return;
      var _e$data = e.data,
          origin = _e$data.origin,
          type = _e$data.type;

      if (origin === 'squarelink' && type === 'onload') {
        result = true;
        popup.postMessage({ origin: 'squarelink-web3-sdk', params: params }, '*');
        popup.focus();
        _addPageLoader(popup);
        resolve({ popup: popup });
        window.removeEventListener('message', function () {});
      }
    }, false);
  });
};

var _addPageLoader = function _addPageLoader(popup) {
  var container = document.createElement('div');
  container.id = 'squarelink-preloader-container';
  container.style = '\n    position: fixed;\n    height: 100%;\n    width: 100%;\n    left: 0;\n    right: 0;\n    top: 0;\n    bottom: 0;\n    z-index: 2147483647;\n    background: rgba(0,0,0,0.5);\n  ';
  /* INITIALIZE PRELOADER */
  var preloader = '<div class="squarelink-preloader" id="squarelink-preloader"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>';

  /* INITIALIZE CLOSE BUTTON */
  var closeButton = '<div class="squarelink-close" id="squarelink-close-button"></div>';

  container.innerHTML = closeButton + preloader;
  document.body.appendChild(container);

  document.getElementById('squarelink-close-button').addEventListener('click', function () {
    popup.close();
  });
};

exports.default = getPopup;
module.exports = exports.default;
//# sourceMappingURL=popup.js.map